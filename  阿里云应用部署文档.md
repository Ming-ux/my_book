## 阿里云应用部署文档

### README
　　　　<font color='red'>**应用环境部署应在同一区域，同一可用区，本文使用截图，区域不一致请忽略，请务必注意在同一区域！！！**</font>
### 1. 创建VPC网络
　　　在创建所有的服务之前，我们需要先选择相应的区域创建一个VPC的专有网络，以保证我们之后创建的服务在同一个网络环境中。
　　　创建步骤：点击控制台的专有VPC网络 >> 选择区域 >> 创建VPC专有网络 >> 填写信息 >> 创建交换机
![imges](http://img0.ph.126.net/83-C3UQ4np1cCeOPb9WKPQ==/6631632914678762169.png)
![imges](http://img0.ph.126.net/MLnPhq088062FUiDF0Rr-Q==/6631809936050838834.png)
![imges](http://img1.ph.126.net/6wiiapJJ5wfnY9SVti5jMg==/6631809936050838844.png)
　<font color='red' size=1>注：创建VPC专有网络的时候网段尽量使用10.0.0.0/8保证后期服务有足够的IP</font>


### 2. 创建OSS存储
　　创建步骤：控制台点击对象存储OSS >> 新建Bucket >> 填写相关信息  如图：
![imges](http://img1.ph.126.net/mMsbSe0xQeJiR7LhkYnb_g==/6631513067911331602.png)　
 
### 3. 创建NAS文件系统
　　创建步骤：控制台点击文件存储 >> 选择VPC区域 >> 创建文件系统 >> 购买存储包 >> 添加挂载点 >> 挂载到VPC网络
![imges](http://img0.ph.126.net/OXwaNoZPXoqLTROiKAUjAQ==/6631992454977936714.png)　
![imges](http://img0.ph.126.net/fP-AIQIPDxRfQg4dFa47SA==/6632049629582587026.png)　
![imges](http://img1.ph.126.net/X23aUnBvLZPwdo7ur2rxIw==/6631531759609009402.png)　
![imges](http://img2.ph.126.net/XTFqx7tCC73HfhuOnUhYQw==/6631817632632223808.png)　
![imges](http://img2.ph.126.net/YZjdV66gYrma2wi9URFYyA==/6631645009306661303.png)　 
 
 <font color='red' size=1>注：nas只支持杭州和北京，华东为杭州，华北为北京，根据需求选择</font>
### 4. 创建redis数据库
　　创建步骤：控制台点击云数据库redis版 >> 选择VPC区域创建实例 >> 选择配置按量收费 >> 选择专有网络
![imges](http://img2.ph.126.net/-Ld7rHI3xISxfJ7yg6jv-Q==/6631662601492720961.png)
![imges](http://img0.ph.126.net/nbQvx-vWLd3nF2T9HJc3Ag==/6631697785864795188.png) 　　
 <font color='red' size=1>注：创建完redis数据库之后需要向阿里售后支持提供实例id，用于升级redis的config功能</font>
### 5. 创建mysql数据库
###### 第一步
创建步骤：控制台点击云数据库RDS版 >> 选择VPC区域创建实例 >> 选择按量付费 >> 配置专有网络
![imges](http://img2.ph.126.net/pT5h6FwgQ8wJ2AX2pmMDSQ==/6632066122257004142.png)
![imges](http://img0.ph.126.net/1LTonJww1oe6zPFfD9Aduw==/6631493276702040324.png)
###### 第二步
管理数据库：点击创建好的数据库 >> 数据安全性 >> 设置白名单 >> 添加ECS内网IP
![imges](http://img1.ph.126.net/qXqKOSbqOi2GgUR7pnx-dQ==/6631480082562509248.png)
![imges](http://img1.ph.126.net/qUda74TLxc9MyBQp-a3iUA==/6632049629582587027.png)
![imges](http://img0.ph.126.net/FRjQ_YD6zV4s7YeNJuqRog==/6632045231536078077.png)
<font color='red' size=1> 注：白名单默认是127.0.0.1，拒绝所有连接，如数据库需要外网连接，请在白名单内添加0.0.0.0/0，允许所有外网地址</font>
###### 第三步
创建数据库和帐号：点击帐号管理 >> 创建帐号 >>  点击数据库管理 >> 选择创建数据库 >> 选择对应帐号管理数据库
![imges](http://img0.ph.126.net/Xi4pW8uvcDWOd9F2PDXFVA==/6631575740074115364.png)
![imges](http://img0.ph.126.net/7-cge-iHRztyyjqB8AaMjg==/6631977061815152973.png)
![imges](http://img0.ph.126.net/1y6tTDl9eqCRu_Zv6QLulg==/6632166177815133504.png)
![imges](http://img2.ph.126.net/sg06YppSb_cXPKAeOrCzSw==/6631565844469460168.png)
<font color='red' size=1> 注：新建数据库默认没有帐号，需要先创建帐号在创建数据库，然后授权给创建好的帐号上面</font>
### 6. 创建负载均衡
　　创建步骤：控制台点击负载均衡 >> 选择区域创建负载均衡 >> 按流量收费 >> 配置监听端口
![imges](http://img1.ph.126.net/GRqgg1qJtiD-jEWMJ9hfGw==/6631637312725273237.png)
![imges](http://img1.ph.126.net/Ro8ipRrGRJ8zhimFhe0mJw==/6632166177815133505.png)
![imges](http://img1.ph.126.net/vuxxFmtxkwYszSO_Q9wEcA==/6631986957419801965.png)
![imges](http://img1.ph.126.net/qrHMKwFdkZWb3Cr1K7ycgg==/6631860513582608254.png)
![imges](http://img2.ph.126.net/NoOPH8qrHy0SllJvDvaQNw==/6631531759609009418.png)
 <font color='red' size=1>注：此负载均衡用于gateway备用</font>
### 7. 创建容器集群
　　创建步骤：控制台点击容器服务 >> 集群 >> 创建集群 >> 选择VPC所在区域 >> 选择节点配置 >> 创建成功
![imges](http://img0.ph.126.net/0YTJw4L3SbtvTVoNIyMqHQ==/6631531759609009413.png)
![imges](http://img0.ph.126.net/WbEYvLWwpCtXHh_nNZ8Ocg==/6631475684515998192.png)
![imges](http://img0.ph.126.net/rgDPoHY8eRfG7b8V6R_SDQ==/6631860513582608256.png)
### 8. 配置域名解析
　　操作步骤：找到mysql、oss、nfs、redis的内网域名(在各个服务的信息页面) >> 点击控制台域名 >> 选择域名 >> 选择域名解析 >> 添加解析
Mysql
![imges](http://img1.ph.126.net/UGADKPmKZ_5zgUMxU-AMDg==/6631707681469458997.png)
 redis
![imges](http://img2.ph.126.net/htia2b_EYK1SK7wkEqQ0aw==/6631491077678784800.png)
 Ｎfs
![imges](http://img0.ph.126.net/QmdGWNdR9lwSPIKI6g9d1g==/6632166177815133507.png)
 Oss ：oss对于vpc网络，每个区域都有固定的域名，域名地址就为，oss名称+固定域名，如我们的oss名称为pipeline-test 那杭州的VPC连接地址就为pipeline-test.vpc100-oss-cn-hangzhou.aliyuncs.com
　　vpc100-oss-cn-beijing.aliyuncs.com 北京
　　vpc100-oss-cn-shenzhen.aliyuncs.com 深圳
　　vpc100-oss-cn-hangzhou.aliyuncs.com 杭州
  　　vpc100-oss-cn-shanghai.aliyuncs.com  上海

![imges](http://img0.ph.126.net/D2aPkw8aFN_U_xZMOOg0rA==/6632044132024450299.png)
![imges](http://img1.ph.126.net/NVhU2has5MNGbBvWS5cURA==/6632087012977930879.png)
### 9. 挂载nas上传jar包
　　步骤：创建一台与所有服务在同一VPC的ECS实例 >> 挂载nfs系统 >> 创建指定目录 >> 上传应用
![imges](http://img2.ph.126.net/rjIib3DIV_RPRb1eDrft9A==/6632091411024443948.png)
 挂载文件：挂载前，您需要确保系统中已经安装了nfs-utils或nfs-common，安装方法如下：
 
CentOS: sudo yum install nfs-utils
 
Ubuntu 或 Debian: sudo apt-get install nfs-common
 
挂载命令：mount -t nfs4 nfs.zyax.cn:/ /app
![imges](http://img1.ph.126.net/2CvbhENZsokX2zZdWm-jag==/6631565844469460173.png)
![imges](http://img0.ph.126.net/JLrtfBWjd_LkqOYY4cOzYQ==/6632099107605838326.png)
![imges](http://img1.ph.126.net/y7Agj161-A5z9GfwkuJ82A==/6631668099050859844.png)
![imges](http://img1.ph.126.net/rbZMJfs0Wk_E68g8cFG0rQ==/6631873707722142934.png)
<font color='red' size=1> 注：应用的目录结构应按与截图保持一致</font>
### 10. 创建集群数据卷
　　操作步骤：点击控制台容器服务 >> 数据卷 >> 选择集群创建数据卷 
![imges](http://img2.ph.126.net/s14nrS4XG5g8RO4inlbdTA==/6631716477562430579.png)
![imges](http://img2.ph.126.net/PA79BB0dIVtKAB0kdD7iLA==/6631632914678762174.png)
###11. 创建镜像仓库
　　我们部署应用所用到的镜像可以通过创建本地镜像仓库的方式，将本地的镜像上传到阿里仓库，可以直接在部署命令里拉取
　　操作步骤：容器服务 >> 镜像 >> 镜像仓库控制台 >> 创建镜像仓库 >> 创建namespace >> 根据需求选择区域创建镜像仓库 >> 根据提示命令上传镜像 >> 获得镜像拉取地址
![imges](http://img1.ph.126.net/FwCBmjFFaTgvumCyoxtkFA==/6631634014190389954.png)
![imges](http://img2.ph.126.net/ycifLgZbxaF8xi6Li7c4kA==/6632096908582582787.png)
![imges](http://img0.ph.126.net/WZid6UUBQX7K2BX1vEa67g==/6631634014190389956.png)
![imges](http://img2.ph.126.net/7SyhJCMpECuv828l6ZYmCg==/6631959469629110543.png)
![imges](http://img0.ph.126.net/9VQHZxnYDz6UN9xnVuXklw==/6632166177815133519.png)
### 12. 通过yml部署应用
　　在用yml编排模版前，需要自己编写部署的应用
　　操作步骤：容器服务 >> 编排模版 >> 我的编排 >> 选择编排模版 >> 创建应用 >> 创建并部署 >> 检查服务部署情况 >> 修改集群SLB监听端口 >> 访问discovery页面　
![imges](http://img1.ph.126.net/NxMkdOYpAWQ5qgWJ-5X2dw==/6632083714443047605.png)
![imges](http://img2.ph.126.net/e--u-wH3hAeYU99SvF8ZIQ==/6632156282210483582.png)
![imges](http://img2.ph.126.net/qFXm0Yp4DIadJMkNaSnnGQ==/6631986957419801969.png)
![imges](http://img1.ph.126.net/Oxmm4ONQGp944y8EA9k29A==/6631634014190389957.png)
![imges](http://img0.ph.126.net/1NDPI6LYrL4Xbt3rqwOTiw==/6631582337143881993.png)
![imges](http://img2.ph.126.net/vZNK1w5_T0hUn_uJoP8xOQ==/6632087012977930880.png)
![imges](http://img0.ph.126.net/OjuvLXz7h9hmn0uTmj5UEg==/6632185969024432884.png)
### 附：
　　**本次部署采用了nfs文件存储系统，用来存放jar包，也可采用把jar包直接封装到镜像当中，这样就无需创建NFS系统、挂载NAS上传jar包、创建数据卷，即省去了目录中的3、9、10步骤，同样，如果采用把jar包封装到镜像当中，编排模版里的volumes模块可以删除！**
![imges](http://img2.ph.126.net/uGE-BneWIv06rnKvidSQVQ==/6631514167422959381.png)
 